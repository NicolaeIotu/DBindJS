/* dbindjs - data binding for Javascript
dbindjs is Copyright (C) 2017-2020 Nicolae Iotu, nicolae.g.iotu@gmail.com
This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
See the GNU Affero General Public License for more details.
You should have received a copy of the GNU Affero General Public License along with this program. If not, see <https://www.gnu.org/licenses/>. */
"use strict";var nonWindow="undefined"==typeof window,nodeEnv="undefined"!=typeof require,dbind=function(){var bindHolder,bindingPoolDescriptor,typeCarrier,argsLen=arguments.length,args0=arguments[0];if(0===argsLen)throw new TypeError("Expecting at least an argument.");if(1===argsLen){if("object"!=typeof args0)throw new TypeError("Expecting at least an argument.");bindHolder=nonWindow?this||dbind:this===window?dbind:this||dbind,bindingPoolDescriptor=args0,typeCarrier=dbind.prototype}else if(argsLen>=2){var args1=arguments[1];if("object"!=typeof args0)throw new TypeError("First argument must be an object.");if("object"!=typeof args1)throw new TypeError("The second argument must be an object.");if(!Object.isExtensible(args0)||Object.isFrozen(args0)||Object.isSealed(args0))throw new TypeError("Make sure the target object is extensible, not frozen and not sealed.");bindHolder=args0,bindingPoolDescriptor=args1,typeCarrier=dbind.prototype}var props=Object.keys(bindingPoolDescriptor),propsLen=props.length;if(0===propsLen)throw new TypeError("Binding descriptor object is empty, or properties are not enumerable.");for(var propName,propValue,hasFunction=!1,i=0;i<props.length;)hasFunction?(propValue=bindingPoolDescriptor[propName=props[i]],Object.prototype.hasOwnProperty.call(bindHolder,"propstore")&&Object.prototype.hasOwnProperty.call(bindHolder,"settings")||typeCarrier.defaultRuntime(bindHolder),"function"==typeof propValue?typeCarrier.addData(bindHolder,propName,propValue,props):typeCarrier.addData(bindHolder,propName,propValue),i++):"function"==typeof bindingPoolDescriptor[props[i]]?(hasFunction=!0,i=0):i++;if(!hasFunction){for(i=0;i<propsLen;i++){if(propName=props[i],!Object.prototype.hasOwnProperty.call(bindHolder.bindstore,propName))return;bindHolder.bindstore[propName]=bindingPoolDescriptor[propName]}if(bindHolder.settings.pause)return;bindHolder.settings.mergeUpdates&&typeCarrier.runUpdateQueue(bindHolder)}};dbind.prototype=Object.create(Object.prototype),dbind.prototype.constructor=dbind,function(){Object.defineProperty(this,"explicitDefaults",{configurable:!1,enumerable:!1,get:function(){return function(){return{value:arguments[0],configurable:!1,enumerable:!1,writable:!1}}}}),Object.defineProperty(this,"explicitNonConfigurable",{configurable:!1,enumerable:!1,get:function(){return function(){return{value:arguments[0],configurable:!1,enumerable:!0,writable:!0}}}}),Object.defineProperties(this,{storeMemberKeys:this.explicitDefaults(["dependencies","previousValue","value"].sort().toString())}),Object.defineProperties(this,{defaultRuntime:{configurable:!1,enumerable:!1,get:function(){return function(){Object.defineProperties(arguments[0],{settings:this.explicitNonConfigurable({mergeUpdates:!0,pause:!1}),updateQueue:this.explicitNonConfigurable([]),bindstore:this.explicitNonConfigurable({}),propstore:this.explicitNonConfigurable({})})}}},runUpdateQueue:{configurable:!1,enumerable:!1,get:function(){return function(){var bindHolder=arguments[0];if(!(bindHolder.updateQueue instanceof Array))throw new TypeError("Error with 'runUpdateQueue': unexpected format for 'updateQueue'");for(var updLen=bindHolder.updateQueue.length,j=0;j<updLen;j++)bindHolder.updateQueue.shift()()}}},addData:{configurable:!1,enumerable:!1,get:function(){return function(){var bindHolder,typeCarrier,propName,propValue,dependencies,addsBindings=4===arguments.length;function tte(){throw new TypeError("@addData")}"object"!=typeof arguments[0]&&arguments[0]!==dbind||"string"!=typeof arguments[1]?tte():(bindHolder=arguments[0],Object.prototype.hasOwnProperty.call(bindHolder,"propstore")&&Object.prototype.hasOwnProperty.call(bindHolder,"bindstore")?(typeCarrier=this,propName=arguments[1].toString(),propValue=arguments[2],addsBindings&&(arguments[3]instanceof Array&&arguments[3].length?dependencies=arguments[3]:tte())):tte()),Object.prototype.hasOwnProperty.call(bindHolder.propstore,propName)&&(delete bindHolder.propstore[propName],delete bindHolder.bindstore[propName]),Object.defineProperties(bindHolder.propstore[propName]={},{value:this.explicitNonConfigurable(addsBindings?propValue.bind(bindHolder.bindstore):propValue),previousValue:this.explicitNonConfigurable(addsBindings?null:propValue),dependencies:this.explicitNonConfigurable(addsBindings?dependencies:null)}),Object.defineProperty(bindHolder.bindstore,propName,{configurable:!0,enumerable:!0,get:function(){return bindHolder.propstore[this].value}.bind(propName),set:function(value){Object.getOwnPropertyNames(bindHolder.propstore[this]).sort().toString()!==typeCarrier.storeMemberKeys?console.log("Unexpected format for propstore."):value!==bindHolder.propstore[this].value&&(bindHolder.propstore[this].previousValue=bindHolder.propstore[this].value,bindHolder.propstore[this].value=value,typeCarrier.updateDataBindings(bindHolder,this.toString()))}.bind(propName)})}}},updateDataBindings:{configurable:!1,enumerable:!1,get:function(){return function(){if(2!==arguments.length||"object"!=typeof arguments[0]&&arguments[0]!==dbind||"string"!=typeof arguments[1])throw new TypeError("'updateDataBindings' unexpected arguments.");var pName,ppp,dpd,bindHolder=arguments[0],pSeek=arguments[1].toString(),bhkeys=Object.keys(bindHolder.propstore),bhkeysLen=bhkeys.length;try{for(var i=0;i<bhkeysLen;i++)pName=bhkeys[i],null!==(dpd=(ppp=bindHolder.propstore[pName]).dependencies)&&-1!==dpd.indexOf(pSeek)&&(bindHolder.settings.mergeUpdates?-1===bindHolder.updateQueue.indexOf(ppp.value)&&bindHolder.updateQueue.push(ppp.value):ppp.value());bindHolder.propstore[pSeek].previousValue=bindHolder.propstore[pSeek].value}catch(e){console.log("Error while updating bindings depending on "+pSeek+" - "+e.message)}}}},reset:{configurable:!1,enumerable:!1,get:function(){return function(){var bindHolder=arguments[0]||dbind,typeCarrier=this||dbind.prototype;if(!Object.prototype.hasOwnProperty.call(bindHolder,"settings"))throw new TypeError("'Reset' called on incompatible object.");typeCarrier.defaultRuntime(bindHolder)}}},pause:{configurable:!1,enumerable:!1,get:function(){return function(){var bindHolder=arguments[0]||dbind;if(!Object.prototype.hasOwnProperty.call(bindHolder,"settings"))throw new TypeError("'Pause' called on incompatible object.");bindHolder.settings.pause=!0}}},resume:{configurable:!1,enumerable:!1,get:function(){return function(){var bindHolder=arguments[0]||dbind,typeCarrier=this||dbind.prototype;if(!Object.prototype.hasOwnProperty.call(bindHolder,"settings"))throw new TypeError("'Resume' called on incompatible object.");bindHolder.settings.pause=!1,typeCarrier.refresh(bindHolder)}}},refresh:{configurable:!1,enumerable:!1,get:function(){return function(){var bindHolder,typeCarrier,bhkeys,bhkeysLen,ppp,pName,originalPauseStatus;bindHolder=arguments[0]||dbind,typeCarrier=this||dbind.prototype,originalPauseStatus=bindHolder.settings.pause,bindHolder.settings.pause=!1;try{bhkeysLen=(bhkeys=Object.keys(bindHolder.propstore)).length;for(var i=0;i<bhkeysLen;i++)pName=bhkeys[i],null===(ppp=bindHolder.propstore[pName]).dependencies&&ppp.value!==ppp.previousValue&&typeCarrier.updateDataBindings(bindHolder,pName);bindHolder.settings.mergeUpdates&&typeCarrier.runUpdateQueue(bindHolder)}catch(e){console.log('Error with "refresh": ',e.message)}finally{bindHolder.settings.pause=originalPauseStatus}}}},update:{configurable:!1,enumerable:!1,get:function(){return function(){this.constructor.apply(this,arguments)}}}})}.call(dbind.prototype),function(){var tp=this.prototype;Object.defineProperties(this,{settings:tp.explicitNonConfigurable({mergeUpdates:!0,pause:!1}),updateQueue:tp.explicitNonConfigurable([]),bindstore:tp.explicitNonConfigurable({}),propstore:tp.explicitNonConfigurable({})}),this.update=function(){this.apply(tp,arguments)},this.reset=function(){this.prototype.reset.apply(tp,arguments)},this.pause=function(){this.prototype.pause.apply(tp,arguments)},this.refresh=function(){this.prototype.refresh.apply(tp,arguments)},this.resume=function(){this.prototype.resume.apply(tp,arguments)}}.call(dbind),Object.seal(dbind.prototype),Object.seal(dbind),module.exports.dbind=dbind;